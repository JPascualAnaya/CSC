#Ancora technical documentation
First version by Pär Engström, April 2008. 
This version by Ge Tan, May 2013. 
This document was produced by the 
[GitHub Flavored Markdown](https://help.github.com/articles/github-flavored-markdown "Markdown").

This document describes the implementation the Ancora web resource. 
For a general description of Ancora and its user interface, 
see the [Ancora publication](http://genomebiology.com/2008/9/2/R34 "Ancora publication").

**Table of contents**

*    [Installation](#installation)
	* [Software dependencies](#dependencies)
	* [GBrowse2](#GBrowse2)
	* [Gbrowse2 Advanced Installation](#GBrowse2Ad)
	* [UCSC Genome Browser source and utilities](#UCSC)
	* [ProServer DAS server](#DAS)
	* [Software components](#SoftwareComponents)
*    [Configuration](#configuration)
	* [Ancora Web Resource](#ancoraweb)
	* [Apache Configuration](#apache)
	* [Data Files](#data)
	* [The CNE database](#cnedb)
    * [MySQL account for Perl scripts](#mysql)
*	[Generating CNEs](#CNEs)
	*	[Obtaining alignment files](#alignment)
    *	[Creating filter files](#filter)
    *	[Scanning for CNEs](#scan)
    *	[Removing unannotated repeats with BLAT](#BLAT)
    *	[Loading CNEs into the cne database](#loadCNEs)
*	[Setting up a genome browser](#genomebrowser)
	*	[Creating an annotation database for GBrowse](#annotationdb)
    *	[Obtaining genome annotations](#genomeAnnotation)

<h2 id="installation">Installation</h2>
 This documentation focuses on the Ancora installation on Olifant at MRC CSC. 
 Olifant is running the CentOS release 5.8 (Final). 
 However, ancora is supposed to run on other Linux/Unix distribution without too much difficulty.

<h3 id="dependencies">Software dependecies</h3>
 The following softwares are essential for the whole implementation.
 
 *  A httpd server (Currently [Apache](http://httpd.apache.org/docs/2.2/ "Apache") 2.2.3 is used on olifant)
 *  [MySQL](http://dev.mysql.com/downloads/mysql/5.0.html "MySQL") client if you have a dedicated MySQL server. if not, MySQL server is alse required. (MySQL 5.0.95 is used on olifant)
 *  [BioPerl](http://www.bioperl.org/wiki/Installing_BioPerl_on_Unix "BioPerl"). Installation is quite straightforward following the instructions. (BioPerl 1.6.1 is used on olifant.)

<h3 id="GBrowse2">GBrowse2</h3>
This implementation of Ancora utilizes the latest version of GBrowse 2.54. 
GBrowse 2.X is a complete rewrite of GBrowse 1.X version. 
There are several advantages compared to the GBrowse 1.X. 
See the [details](http://gmod.org/wiki/GBrowse_2.0_HOWTO#Installation_from_Source_Code "GBrowse").

Since the GBrowse 2.X is perl-based and 
all the modules are hosted on [CPAN](http://search.cpan.org/~lds/GBrowse-2.54/), 
the easiest way to install GBrowse 2 is using the standard Perl module 
building procedure.

For a smooth installation, 
please install some prerequisites before launching the GBrowse2 installation. 
Details are mentioned on the [page](http://gmod.org/wiki/GBrowse_2.0_Prerequisites). 
It is highly recommened to use the common package managers, Debian(DEB) 
or RedHat Package Manager(RPM).

After installing the prerequisites, run this command in terminal

```sh
sudo perl -MCPAN -e 'install Bio::Graphics::Browser2'
```

If not all the necessary prerequisites are installed, it will be notified during the test step. 
During the installation, there are some prompted configuration questions about the location of files.
In principle, the default paths are fine and you can customize it to fit your needs.
On olifant, we configrued as follows:

* Directory for GBrowse's config and support files? [/etc/gbrowse2] /opt/www/gbrowse2/conf
* Directory for GBrowse's static images & HTML files? [/var/www/html/gbrowse2] /opt/www/gbrowse2/html
* Directory for GBrowse's temporary data [/var/tmp/gbrowse2] /opt/www/gbrowse2/tmp
* Directory for GBrowse's sessions, uploaded tracks and other persistent data [/var/lib/gbrowse2] /opt/www/gbrowse2/lib
* Directory for GBrowse's example databases [/var/lib/gbrowse2/databases] /opt/www/gbrowse2/databases
* Directory for GBrowse's CGI script executables? [/var/www/cgi-bin/gb2] /opt/www/gbrowse2/cgi-bin
* Internet port to run demo web site on (for demo)? [8000]
* Apache loadable module directory (for demo)? [/etc/httpd/modules]
* User account under which Apache daemon runs? [apache]
* Automatically update Apache config files to run GBrowse? [y]
* Automatically update system config files to run gbrowse-slave? [y]

After the installation, the GBrowse2 demos should be accessable now. 
Type ```YourServersIP/gbrowse2``` in the internet browser and 
try the example database *yeast*.

However, because of some bugs in ```Bio::Graphics 2.33```, 
the tracks generated by plugins might complain some errors like 

```sh
Can't locate object method "height" via package "gdTinyFont"
(perhaps you forgot to load "gdTinyFont"?) at /usr/local/share/perl/5.8.8/Bio/Graphics/Panel.pm line 641. at
/usr/local/lib/perl/5.8.8/Bio/Graphics/Browser2/Render.pm line 3678.
```

As long as Lincoln D. Stein does not fix the bug, just downgrade to the ```Bio::Graphics 2.32```. Here is the trick how to do it.

```sh
wget http://backpan.perl.org/authors/id/L/LD/LDS/Bio-Graphics-2.32.tar.gz
tar xzf Bio-Graphics-2.32.tar.gz
perl Build.PL
./Build
./Build test
sudo ./Build install --uninst 1
```

The "--uninst 1" will make sure that the files for the
newer (2.33) version are removed in case they are installed 
in another directory.
**Note**: For some unknown reasons, the tracks are not displayed on Mac OS 10.8.3 with Firefox 20.0, Safari 6.0.4 and Opera 12.15. However, Chrome 26.0.1410.65 works fine. So far, it works on Windows 7 with all major browsers.

<h3 id="GBrowse2Ad">GBrowse2 Advanced Installation</h3>
This section is optional and incomplete. The advance installation should cover the topics such as *FastCGI*, *User Account Database*, *Displaying Next Generation Sequencing Data*, *Configuring the Uploaded Track Database*.

<h4 id="FastCGI">Running GBrowse under FastCGI</h4>
The idea of FastCGI is to make the script as a long-running process at the first time of the script is requested. 
By eliminating the startup time for later use of script, 
the responsiveness of a FastCGI is significantly improved.

To use this facility, you will need a version of Apache equipped with FastCGI support, 
the module [mod_fcgid](http://httpd.apache.org/mod_fcgid/). 
For a Debian (DEB) based system,

```sh
sudo apt-get install libapache2-mod-fastcgi libfcgi-perl
```

or for Cent OS,

```sh
cd /etc/yum.repos.d/
wget http://centos.karan.org/kbsingh-CentOS-Extras.repo
sudo vim /etc/yum.repos.d/kbsingh-CentOS-Extras.repo 
# set gpgcheck to 0 and enabled to 1 in the [kbs-CentOS-Testing] section.
yum install mod_fcgid
# Down the latest atomic-release rpm from http://www6.atomicorp.com/channels/atomic/centos/5/x86_64/RPMS/
# Install atomic-release rpm:
rpm -Uvh atomic-release*rpm
yum install fcgi-perl
```

**Note**: Because the olifant has a old version of *Apache* and *mod_fcgid*. 
You may need to adapt the GBrowse2 conf file for Apache 
(/etc/httpd/conf.d/gbrowse2.conf on olifant) 
to the older version of *mod_fcgid* with the names mapping 
described on the [page](http://httpd.apache.org/mod_fcgid/mod/mod_fcgid.html).

<h4 id="User">User Account Database</h4>
To be implemented

<h4 id="">Displaying Next Generation Sequencing Data</h4>
To be implemented

<h4 id="">Configuring the Uploaded Track Database</h4>
To be implemented

<h3 id="UCSC">UCSC Genome Browser source and utilities</h3>
The UCSC Genome Browser source code is needed to compile the C program 
for detecting CNEs, which makes use of several library functions 
from the UCSC source. 
The UCSC Genome Browser source also contains a collection of useful utilities, 
some of which are needed at steps below. 
It is recommended to compile all the UCSC utilities by following the instructions in the README file in the UCSC source package. 
Short story on olifant,

```sh
export MACHTYPE=x86_64
export MYSQLINC=/usr/include/mysql
export MYSQLLIBS="/usr/lib64/mysql/libmysqlclient.a -lz"
export PATH=$HOME/bin/$MACHTYPE:$PATH
mkdir -p $HOME/bin/$MACHTYPE.
wegt http://hgdownload.cse.ucsc.edu/admin/jksrc.zip
unzip jksrc.zip
cd kent/src
make libs
cd utils/
make
```

<h3 id="DAS">ProServer DAS server</h3>
To be implemented

<h3 id="SoftwareComponents">Software components</h3>
Ancora requires two software packages developed in Boris Lenhard’s group: 
cne and AT. The cne package contains Perl libraries, 
C source code and Perl and bash scripts for detecting and 
working with CNEs, as well as Perl libraries and CGI scripts 
directly underlying the Ancora web resource. 
The AT package is a collection of Perl modules related to genome 
and transcriptome sequence analysis. 
They were largely implemented by Pär Engström during his PhD studies 
but also include contributions from several other past 
and present members of the Lenhard group. 
Ancora only uses a few well-tested modules from the AT package, 
which also includes many modules in early stages of development.

The cne and AT packages are maintained in the CSC repository. 
To retrieve the most recent versions, do:

```sh
git clone git@github.com:ge11232002/CSC.git
```

One copy of the packages should be placed under /opt/www/cne and /opt/www/AT, respectively, 
where the Ancora genome browser will access them from.
This could be done by creating soft links for the *cne* and *AT* under */opt/www/*.
To run scripts that use the modules, 
you will have to add the installation paths to your PERL5LIB environment variable. 
If you use bash as your shell, 
you can do this by adding the following line to the file ~/.bashrc:

```sh
export PERL5LIB=/opt/www/AT/lib:/opt/www/cne/perl_lib:$PERL5LIB
```

(If you want scripts to use a working copy of the modules in a different location, modify the above line accordingly.)
The cne/tools directory in the cne package contains source code for several C programs. 
Ancora currently only needs one of these programs: ceScan, 
the program we use to detect CNE. 
Instructions for how to compile the C programs are in cne/tools/README.txt.

<h2 id="configuration">Configuration</h2>
This section will describe all the necessary configurations step by step
for setting up the Ancora web resource.

<h3 id="ancoraweb">Ancora Web Resource</h3>
Under the repository, there are two other folders *ancora* and *gbrowse2*,
besides the *cne* and *AT* packages.
The *ancora* directory contains html and cgi files 
related to the Ancora web resource,
while the *gbrowse2* directory contains the *conf* files for GBrowse2.
If you are setting up the Ancora web resource, 
you will need to copy some files to the ancora and gbrowse2 directory on your server. 
On olifant, they are ```/opt/www/ancora``` and ```/opt/www/gbrowse2``` 
(As we installed GBrowse2 to this directory).
The following commands create the links there:

```sh
cd ancora
## the html files
ln -s html /opt/www/ancora/
## the cgi files
ln -s cgi-bin /opt/www/ancora/
## the das server settings
ln -s Bio-Das-ProServer /opt/www/ancora/
## put the cgi files to GBrowse cgi-bin folder
cd gbrowse2
ln -s cgi-bin/* /opt/www/gbrowse2/cgi-bin/
## put the gbrowse conf files to the GBrowse's conf folder 
ln -s conf/*.conf /opt/www/gbrowse2/conf/
## put the gbrowse plugins to the GBrowse's plugins folder
ln -s conf/plugins/* /opt/www/gbrowse2/conf/plugins/
```

<h3 id="apache">Apache Configuration</h3>
The Apache httpd server is configured to look for html files under
*/var/www/html* and CGI scripts in */var/www/cgi-bin*.
However, if we use the technique called "VirtualHost",
the html files can be left under ```/opt/www/ancora```.
The mapping of the domain http://ancora.olifant.cscdom.csc.mrc.ac.uk/ 
to this directory is configured in Apache configuration file ```/etc/httpd/conf```.

```
<VirtualHost *:80>
	ServerName ancora.olifant.cscdom.csc.mrc.ac.uk
	ScriptAlias /cgi-bin /opt/www/gbrowse2/cgi-bin
	DocumentRoot /opt/www/ancora/html
</VirtualHost>
```
**Note**: When the CGI script is called by ```/cgi-bin/gbrowse```,
the CGI will run in the traditional mode.
If you want to take the advantage of FastCGI, 
the CGI will be executed in ```/fgb2/gbrowse```.
The settings of FastCGI for GBrowse2 is in ```/etc/httpd/conf.d/gbrowse2.conf```.
By default, Ancora will call the CGI in FastCGI mode.

<h3 id="data">Data Files</h3>
Ancora expects genome assembly sequences in binary 2bit format to be present under 
/export/data/goldenpath. 
There should be one subdirectory for each assembly, 
named using a UCSC assembly identifier (e.g. hg18, mm9) 
or some other suitable identifier for assemblies not served by UCSC. 
Each such subdirectory should contain a file named assembly.2bit 
containing the soft-masked assembly sequence. 
Two-bit files can be made by downloading the assembly 
in soft-masked fasta format from http://genome.ucsc.edu/ 
and converting it to 2bit format using the program faToTwoBit, 
which is part of the UCSC utilities. E.g. 
for the latest human assembly:

```sh
cd /export/data/goldenpath
mkdir hg18
cd hg18
wget http://hgdownload.cse.ucsc.edu/goldenPath/hg18/bigZips/chromFa.zip
unip chromFa.zip
faToTwoBit *.fa assembly.2bit
rm *.fa chromFa.zip
```
We use additional files (annotation and aligment files) from UCSC 
in the CNE detection pipeline and 
in constructing the other annotation tracks shown in the genome browser. 
How to retrieve these files is described in the corresponding sections below.

<h3 id="cnedb">The CNE database</h3>
Ancora reads information about genome assemblies and CNEs 
from a database called cne served by the MySQL server on the same host. 
Programmatic access to this database is provided 
by the Perl module CNE::DB in the cne package.

If this database does not exist, create it:

```sh
mysql -u username -p -e 'create database cne'
mysql -u username -p -e 'grant select on cne.* to nobody@localhost'
```
(Replacing username with your MySQL username, or root if necessary.) 
The second command gives user nobody read access to the database. 
This is necessary because Ancora accesses the database as user nobody.

Presently there is only one table that must exist in the database. 
This table is called assembly and holds information 
about the genome assemblies for which comparisons are available in Ancora. 
The cne package contains a file with SQL commands 
that create the table and fills it with sample data:

```sh
mysql -u username -p cne < cne/scripts/cne_pipeline/create_assembly_table.sql
```

If the assembly you are setting up a browser for is not already present in this table, 
you need to execute an SQL INSERT statement
to add a row describing the assembly. 
Most of the fields in the table are self-explanatory. 
The following may not be:
*	ensembl_ver – Currently only used by the DAS service. Specifies which Ensembl version that DAS tracks should be added to. Leave blank for the most recent Ensembl release, or add a version in the form of an archive name (e.g. “apr2007”) for an older release.
*	default_ensembl_loc – Currently only used by the DAS service. Specifies which location the user should be taken to in Ensembl when tracks are added. Specify as an Ensembl location string (e.g. “7:8541098-8656549”).
*	ucsc_db – Deprecated, so can be left blank. Earlier releases of Ancora required an UCSC annotation database to be present for some assemblies.

To add one new row into the table or update one row,

```sql
INSERT INTO assembly 
(assembly_id, assembly_name, organism_common, organism_latin, ensembl_ver, default_ensembl_loc) 
VALUES 
("hg19", "NCBI Build 37", "human", "Homo sapiens", "feb2009", "11:31766034-31797085");
UPDATE assembly
SET ensembl_ver="nov2009", default_ensembl_loc="GL172646.1:2369612-2552500"
WHERE assembly_id="xenTro3";
```

<h3 id="mysql">MySQL account for Perl scripts</h3>
Generating CNEs and setting up the annotation database for Ancora 
involves running several Perl scripts that need to access local MySQL databases. 
Some of these scripts require that a MySQL username and password 
are specified in a file called MyPerlVars.pm 
located in a directory mentioned in your PERL5LIB environment variable. 
I have such a file in a directory called .perl under my home directory, 
and have added the following line to my .bashrc to 
make Perl look for libraries in this directory:

```sh
export PERL5LIB=~/.perl:$PERL5LIB
```

The file MyPerlVars.pm should contain the following lines:

```perl
package MyPerlVars;
use warnings;
use strict;

use Exporter;

our @ISA = qw(Exporter);
our @EXPORT_OK = qw($sqlUser $sqlPass);

our $sqlUser = "username"; # replace username with your username
our $sqlPass = "password"; # replace password with your password

1;
```

For security reasons, 
it is a good idea to change the permissions of MyPerlVars.pm file 
so that nobody but you can read it.

<h2 id="CNEs">Generating CNEs</h2>
To scan for CNEs, 
you need to have the cne package, the AT package and 
genome assembly sequences installed as outlined above. 
In addition, you need to obtain alignment files for the genomes 
that are to be compared, and create filter files that specify 
which regions (typically exons and repeats) 
that are to be ignored in the scanning. 
The alignment and filter files are not required to run the web resource, 
so they can be removed after CNE generation.

<h3 id="alignment">Obtaining alignment files</h3>
The program that scans for CNEs (ceScan) takes alignments in axt format as input. 
We typically obtain alignment files in axt format from UCSC and 
keep them under ```/export/downloads/ucsc/axtNet```.
This directory contains one subdirectory for each genome assembly. 
The directories are named using UCSC assembly identifiers, 
as for the genome assembly directories (see above). 
Each directory contains axt files for pairwise net alignments 
with the corresponding assembly as the reference; 
e.g. directory ```/export/downloads/ucsc/axtNet/hg18``` 
only contains net alignments where hg18 is reference. 
To detect CNEs between two genomes, 
you need two sets of net alignments - 
one where each genome is the reference 
(see the [Ancora](http://genomebiology.com/2008/9/2/R34) 
paper for an explanation of the rationale behind this).
The files we download from UCSC are typically compressed with gzip. 
There is no need to decompress them, 
because ceScan can read gzip-compressed files.

As an example, to detect CNEs between the current human and mouse genome assemblies, 
the required alignment files can be obtained as follows:
```sh
rsync -avzP \
  rsync://hgdownload.cse.ucsc.edu/goldenPath/hg19/vsMm10/axtNet/* \
  /export/downloads/ucsc/axtNet/hg19
rsync -avzP \
  rsync://hgdownload.cse.ucsc.edu/goldenPath/mm10/vsHg19/axtNet/* \
  /export/downloads/ucsc/axtNet/mm10
```
I prepared a script ```cne/scripts/cne_pipeline/downloadAlignments.r``` 
to download the pairwise alignments.

<h3 id="filter">Creating filter files</h3>
Filer files list regions to be ignored in the scan. 
One filter file should be created for each assembly.


<h2 id="genomebrowser">Setting up a genome browser</h2>
Setting up a genome browser for a new assembly involves 
creating and loading CNEs for the assembly, 
as described in the previous section, 
as well as a number of additional steps detailed in this section.

<h3 id="annotationdb">Creating an annotation database for GBrowse</h3>
Create a MySQL database to store the annotation (genes etc) 
that is to be shown alongside the CNEs. 
For the main Ancora installation on olifant, 
we name these databases gbrowse_gff_assembly_id, 
e.g. gbrowse_gff_hg19 for the latest human assembly. 
Make sure the user nobody@localhost has SELECT permission on the database
as described above. 

<h3 id="genomeAnnotation">Obtaining genome annotations</h3>
This step usually involves more manual work than the other steps, 
because annotations are available in diverse databases and 
in different and changing formats. 
To keep things simple, 
we have tried to retrieve as much annotation as possible 
from the UCSC Genome Browser database.
Begin by creating a local database to hold UCSC annotations for the assembly, 
if one does not already exist. 
We have named these databases UCSC_id, 
replacing id with the UCSC assembly id, e.g. UCSC_hg18, UCSC_mm9.





